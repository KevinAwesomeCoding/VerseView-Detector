# -*- coding: utf-8 -*-
import re
import unicodedata

# ------------------- Malayalam â†’ English book mapping -------------------
BOOKS = {
    # OT
    "à´‰à´²àµà´ªà´¤àµà´¤à´¿": "Genesis", "à´ªàµà´±à´ªàµà´ªà´¾à´Ÿàµ": "Exodus", "à´²àµ‡à´µàµà´¯à´ªàµà´¸àµà´¤à´•à´‚": "Leviticus", "à´²àµ‡à´µàµà´¯": "Leviticus",
    "à´²àµ‡à´µàµà´¯à´ªàµ": "Leviticus", "à´¸à´‚à´–àµà´¯à´¾à´ªàµà´¸àµà´¤à´•à´‚": "Numbers", "à´¸à´‚à´–àµà´¯": "Numbers", "à´†à´µàµ¼à´¤àµà´¤à´¨à´‚": "Deuteronomy",
    "à´¯àµ‹à´¶àµà´µ": "Joshua", "à´¨àµà´¯à´¾à´¯à´¾à´§à´¿à´ªà´¨àµà´®à´¾àµ¼": "Judges", "à´±àµ‚à´¤àµà´¤àµ": "Ruth", "à´°àµ‚à´¤àµà´¤àµ": "Ruth",
    "1 à´¶à´®àµà´µàµ‡àµ½": "1 Samuel", "1à´¶à´®àµ‚à´µàµ‡àµ½": "1 Samuel", "à´’à´¨àµà´¨àµ à´¶à´®àµ‚à´µàµ‡àµ½": "1 Samuel",
    "2 à´¶à´®àµ‚à´µàµ‡àµ½": "2 Samuel", "2à´¶à´®àµ‚à´µàµ‡àµ½": "2 Samuel", "à´°à´£àµà´Ÿàµ à´¶à´®àµ‚à´µàµ‡àµ½": "2 Samuel",
    "1 à´°à´¾à´œà´¾": "1 Kings", "à´’à´¨àµà´¨àµ à´°à´¾à´œàµ": "1 Kings", "à´’à´¨àµà´¨àµ à´°à´¾à´œà´¾": "1 Kings",
    "1 à´°à´¾à´œà´¾à´•àµà´•à´¨àµà´®à´¾àµ¼": "1 Kings", "1à´°à´¾à´œà´¾à´•àµà´•à´¨àµà´®à´¾àµ¼": "1 Kings", "à´’à´¨àµà´¨àµ à´°à´¾à´œà´¾à´•àµà´•à´¨àµà´®à´¾àµ¼": "1 Kings",
    "2 à´°à´¾à´œà´¾": "2 Kings", "à´°à´£àµà´Ÿàµ à´°à´¾à´œàµ": "2 Kings", "à´°à´£àµà´Ÿàµ à´°à´¾à´œà´¾": "2 Kings",
    "2 à´°à´¾à´œà´¾à´•àµà´•à´¨àµà´®à´¾àµ¼": "2 Kings", "2à´°à´¾à´œà´¾à´•àµà´•à´¨àµà´®à´¾àµ¼": "2 Kings", "à´°à´£àµà´Ÿàµ à´°à´¾à´œà´¾à´•àµà´•à´¨àµà´®à´¾àµ¼": "2 Kings",
    "1 à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´‚": "1 Chronicles", "1à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´‚": "1 Chronicles", "à´’à´¨àµà´¨àµ à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´‚": "1 Chronicles",
    "2 à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´‚": "2 Chronicles", "2à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´‚": "2 Chronicles", "à´°à´£àµà´Ÿàµ à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´‚": "2 Chronicles",
    "1 à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´™àµà´™àµ¾": "1 Chronicles", "1à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´™àµà´™àµ¾": "1 Chronicles", "à´’à´¨àµà´¨àµ à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´™àµà´™àµ¾": "1 Chronicles",
    "2 à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´™àµà´™àµ¾": "2 Chronicles", "2à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´™àµà´™àµ¾": "2 Chronicles", "à´°à´£àµà´Ÿàµ à´¦à´¿à´¨à´µàµƒà´¤àµà´¤à´¾à´¨àµà´¤à´™àµà´™àµ¾": "2 Chronicles",
    # More OT
    "à´Žà´¸àµà´°à´¾": "Ezra", "à´Žà´¸àµà´°": "Ezra", "à´¨àµ†à´¹àµ†à´®àµà´¯à´¾à´µàµ": "Nehemiah", "à´¨àµ†à´¹àµ†à´®àµà´¯à´¾": "Nehemiah", "à´¨àµ†à´¹à´®à´¿à´¯": "Nehemiah",
    "à´Žà´¸àµà´¤àµ‡àµ¼": "Esther", "à´Žà´¸àµà´¥àµ‡àµ¼": "Esther", "à´‡à´¯àµà´¯àµ‹à´¬àµ": "Job", "à´¸à´™àµà´•àµ€àµ¼à´¤àµà´¤à´¨à´™àµà´™àµ¾": "Psalms", "à´¸à´™àµà´•àµ€àµ¼à´¤àµà´¤à´¨à´‚": "Psalms",
    "à´¸à´¦àµƒà´¶àµà´¯à´µà´¾à´•àµà´¯à´™àµà´™àµ¾": "Proverbs", "à´¸à´¦àµƒà´¶àµà´¯à´µà´¾à´•àµà´¯à´‚": "Proverbs", "à´¸à´¦àµƒà´¶àµà´¯à´‚": "Proverbs", "à´¸à´­à´¾à´ªàµà´°à´¸à´‚à´—à´¿": "Ecclesiastes",
    "à´ªàµà´°à´¸à´‚à´—à´¿": "Ecclesiastes", "à´‰à´¤àµà´¤à´®à´—àµ€à´¤à´‚": "Song of Solomon", "à´ªà´°à´®à´—àµ€à´¤à´‚": "Song of Solomon", "à´¯àµ†à´¶à´¯àµà´¯à´¾à´µàµ": "Isaiah",
    "à´¯àµ†à´¶à´¯àµà´¯à´¾": "Isaiah", "à´à´·àµà´¯à´¾": "Isaiah", "à´¯à´¿à´°àµ†à´®àµà´¯à´¾à´µàµ": "Jeremiah", "à´‡à´° à´®àµà´¯à´¾à´µàµ‚": "Jeremiah", "à´¯à´¿à´°àµ†à´®àµà´¯à´¾": "Jeremiah",
    "à´µà´¿à´²à´¾à´ªà´™àµà´™àµ¾": "Lamentations", "à´µà´¿à´²à´¾à´ªà´‚": "Lamentations", "à´¯àµ†à´¹àµ†à´¸àµà´•àµ‡àµ½": "Ezekiel", "à´¯à´¹àµ à´¸àµà´•à´¿àµ½": "Ezekiel",
    "à´Žà´¸à´•àµà´•à´¿à´¯àµ‡àµ½": "Ezekiel", "à´¦à´¾à´¨à´¿à´¯àµ‡àµ½": "Daniel", "à´¹àµ‹à´¶àµ‡à´¯à´¾à´µàµ": "Hosea", "à´¹àµ‹à´¶àµ‡à´¯à´¾": "Hosea", "à´¹àµ‹à´¸à´¿à´¯": "Hosea",
    "à´¹àµ‹à´¶àµ‡à´¯": "Hosea", "à´¯àµ‹à´µàµ‡àµ½": "Joel", "à´¯àµ‹à´¬àµ‡àµ½": "Joel", "à´†à´®àµ‹à´¸àµ": "Amos", "à´’à´¬à´¦àµà´¯à´¾à´µàµ": "Obadiah", "à´’à´¬à´¦àµà´¯à´¾": "Obadiah",
    "à´“à´¬à´¦àµà´¯à´¾à´µàµ": "Obadiah", "à´¯àµ‹à´¨": "Jonah", "à´¯àµ‹à´¨à´¾": "Jonah", "à´®àµ€à´–à´¾ à´ªàµà´¸àµà´¤à´•à´‚": "Micah", "à´®àµ€à´–à´¾à´ªàµà´¸àµà´¤à´•à´‚": "Micah",
    "à´®àµ€à´–à´¾": "Micah", "à´¨à´¾à´¹àµà´‚": "Nahum", "à´¹à´¬à´•àµà´•àµ‚à´•àµà´•àµ": "Habakkuk", "à´…à´¬àµ‚à´•àµà´•": "Habakkuk", "à´…à´¬àµà´•àµà´•": "Habakkuk",
    "à´¸àµ†à´«à´¨àµà´¯à´¾à´µàµ": "Zephaniah", "à´¸àµ†à´«à´¨àµà´¯à´¾à´µàµ": "Zephaniah", "à´¸à´« à´¨àµà´¯": "Zephaniah", "à´¸àµ†à´«à´¨àµà´¯à´¾": "Zephaniah",
    "à´¹à´—àµà´—à´¾à´¯à´¿": "Haggai", "à´¸àµ†à´–à´°àµà´¯à´¾à´µàµ": "Zechariah", "à´¸à´•àµà´•à´±à´¿à´¯à´¯àµà´Ÿàµ† à´ªàµà´¸àµà´¤à´•à´‚": "Zechariah", "à´¸à´•àµà´•à´±à´¿à´¯": "Zechariah",
    "à´¸àµ†à´–à´°àµà´¯à´¾": "Zechariah", "à´®à´²à´¾à´–à´¿": "Malachi",
    # NT
    "à´®à´¤àµà´¤à´¾à´¯à´¿": "Matthew", "à´®àµ¼à´•àµà´•àµ‹à´¸àµ": "Mark", "à´²àµ‚à´•àµà´•àµ‹à´¸àµ": "Luke", "à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "John",
    "à´…à´ªàµà´ªàµŠà´¸àµà´¤à´²à´ªàµà´°à´µàµƒà´¤àµà´¤à´¿à´•àµ¾": "Acts", "à´…à´ªàµà´ªàµ‹à´¸àµà´¤àµ‹à´² à´ªàµà´°à´µàµ¼à´¤àµà´¤à´¿": "Acts", "à´±àµ‹à´®àµ¼": "Romans",
    "1 à´•àµŠà´°à´¿à´¨àµà´¤àµà´¯àµ¼": "1 Corinthians", "1à´•àµŠà´°à´¿à´¨àµà´¤àµà´¯àµ¼": "1 Corinthians", "à´’à´¨àµà´¨àµ à´•àµŠà´°à´¿à´¨àµà´¤àµà´¯àµ¼": "1 Corinthians",
    "à´’à´¨àµà´¨àµ à´•àµŠà´°à´¿à´¨àµà´¤àµà´¯à´°àµ": "1 Corinthians", "2 à´•àµŠà´°à´¿à´¨àµà´¤àµà´¯àµ¼": "2 Corinthians", "2à´•àµŠà´°à´¿à´¨àµà´¤àµà´¯àµ¼": "2 Corinthians",
    "à´°à´£àµà´Ÿàµ à´•àµŠà´°à´¿à´¨àµà´¤àµà´¯àµ¼": "2 Corinthians", "à´°à´£àµà´Ÿàµ à´•àµŠà´°à´¿à´¨àµà´¤àµà´¯à´°àµ": "2 Corinthians", "2 à´•àµŠà´°à´¿à´¨àµà´¤àµà´¯à´°àµ": "2 Corinthians",
    "à´—à´²à´¾à´¤àµà´¯àµ¼": "Galatians", "à´—à´²à´¾à´¤àµà´¯ à´²àµ‡à´–à´¨à´‚": "Galatians", "à´Žà´«àµ†à´¸àµà´¯àµ¼": "Ephesians", "à´Žà´«àµ†à´¸àµà´¯ à´²àµ‡à´–à´¨à´‚": "Ephesians",
    "à´«à´¿à´²à´¿à´ªàµà´ªà´¿à´¯àµ¼": "Philippians", "à´•àµŠà´²àµ‹à´¸àµà´¯àµ¼": "Colossians", "à´•àµŠà´²àµ‹à´¸àµà´¯àµ¼ à´²àµ‡à´–à´¨à´‚": "Colossians",
    "1 à´¤àµ†à´¸àµà´¸à´²àµ‹à´¨à´¿à´•àµà´•àµà´¯àµ¼": "1 Thessalonians", "à´’à´¨àµà´¨àµ à´¤àµ†à´¸àµà´¸à´²àµ‹à´¨à´¿à´•àµà´•": "1 Thessalonians", "1à´¤àµ†à´¸àµà´¸à´²àµ‹à´¨à´¿à´•àµà´•àµà´¯àµ¼": "1 Thessalonians",
    "à´’à´¨àµà´¨àµ à´¤àµ†à´¸àµà´¸à´²àµ‹à´¨à´¿à´•àµà´•àµà´¯àµ¼": "1 Thessalonians", "2 à´¤àµ†à´¸àµà´¸à´²àµ‹à´¨à´¿à´•àµà´•àµà´¯àµ¼": "2 Thessalonians", "2à´¤àµ†à´¸àµà´¸à´²àµ‹à´¨à´¿à´•àµà´•àµà´¯àµ¼": "2 Thessalonians",
    "à´°à´£àµà´Ÿàµ à´¤àµ†à´¸àµà´¸à´²àµ‹à´¨à´¿à´•àµà´•àµà´¯àµ¼": "2 Thessalonians", "à´°à´£àµà´Ÿàµ à´¸à´¿à´²àµ‹à´£à´¿àµ½": "2 Thessalonians", "à´°à´£àµà´Ÿàµ à´¤àµ†à´¸àµà´¸à´²àµŠà´¨àµ€à´•àµà´¯àµ¼": "2 Thessalonians",
    "2 à´¤àµ†à´¸àµà´¸à´²àµŠà´¨àµ€à´•àµà´¯àµ¼": "2 Thessalonians", "1 à´¤à´¿à´®àµ‹à´¤àµà´¤àµ†à´¯àµ‹à´¸àµ": "1 Timothy", "1à´¤à´¿à´®àµ‹à´¤àµà´¤àµ†à´¯àµ‹à´¸àµ": "1 Timothy",
    "à´’à´¨àµà´¨àµ à´¤àµ€à´®àµ‹à´¤àµà´¤à´¿à´¯àµ‹à´¸àµ": "1 Timothy", "1à´¤à´¿à´®àµ‹à´¤àµà´¤à´¿": "1 Timothy", "1 à´¤à´¿à´®àµ‹à´¤àµà´¤à´¿": "1 Timothy", "à´’à´¨àµà´¨àµ à´¤à´¿à´®àµ‹à´¤àµà´¤à´¿": "1 Timothy",
    "2 à´¤à´¿à´®àµ‹à´¤àµà´¤à´¿à´¯àµ‹à´¸àµ": "2 Timothy", "2 à´¤à´¿à´®àµ‹à´¤àµà´¤à´¿": "2 Timothy", "à´°à´£àµà´Ÿàµ à´¤à´¿ à´®à´¤à´¿": "2 Timothy", "2à´¤à´¿à´®àµ‹à´¤àµà´¤àµ†à´¯àµ‹à´¸àµ": "2 Timothy",
    "à´°à´£àµà´Ÿàµ à´¤à´¿à´®àµ‹à´¤àµà´¤àµ†à´¯àµ‹à´¸àµ": "2 Timothy", "à´¤àµ€à´¤àµà´¤àµŠà´¸àµ": "Titus", "à´¤àµ€à´¤àµŠà´¸àµ": "Titus", "à´¤àµ€à´¤àµà´¤àµ‹à´¸àµ": "Titus", "à´«à´¿à´±àµ‹à´¸àµ": "Titus",
    "à´«à´¿à´²àµ‡à´®àµ‹àµ»": "Philemon", "à´«à´¿à´²àµ‡à´®àµ‹àµ» à´²àµ‡à´–à´¨à´‚": "Philemon", "à´«à´¿à´²àµ‹à´®à´¿à´¨ à´²àµ‡à´–à´¨à´‚": "Philemon", "à´Žà´¬àµà´°à´¾à´¯àµ¼": "Hebrews",
    "à´Žà´¬àµà´°à´¾à´¯": "Hebrews", "à´Žà´¬àµà´°à´¾à´¯àµ¼ à´Žà´´àµà´¤à´¿à´¯ à´²àµ‡à´–à´¨à´‚": "Hebrews", "à´¯à´¾à´•àµà´•àµ‹à´¬àµ": "James", "à´¯à´¾à´•àµà´•àµ‹à´¬à´¿à´¨àµ† à´²àµ‡à´–à´¨à´‚": "James",
    "1 à´ªà´¤àµà´°àµ‹à´¸àµ": "1 Peter", "1à´ªà´¤àµà´°àµ‹à´¸àµ": "1 Peter", "à´ªà´¤àµà´°àµ‹à´¸à´¿à´¨àµ† à´’à´¨àµà´¨à´¾à´‚ à´²àµ‡à´–à´¨à´‚": "1 Peter", "à´’à´¨àµà´¨àµ à´ªà´¤àµà´°àµ‹à´¸àµ": "1 Peter",
    "2 à´ªà´¤àµà´°àµ‹à´¸àµ": "2 Peter", "2à´ªà´¤àµà´°àµ‹à´¸àµ": "2 Peter", "à´°à´£àµà´Ÿàµ à´ªà´¤àµà´°àµ‹à´¸àµ": "2 Peter", "à´°à´£àµà´Ÿàµ à´ªà´¤àµà´°àµ‹à´¸àµ": "2 Peter",
    "à´ªà´¤àµà´°àµ‹à´¸à´¿à´¨àµ† à´°à´£àµà´Ÿà´¾à´‚ à´²àµ‡à´–à´¨à´‚": "2 Peter", "1 à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "1 John", "1à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "1 John", "à´’à´¨àµà´¨àµ à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "1 John",
    "à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ» à´Žà´´àµà´¤à´¿à´¯ à´’à´¨àµà´¨à´¾à´‚ à´²àµ‡à´–à´¨à´‚": "1 John", "2 à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "2 John", "2à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "2 John",
    "à´°à´£àµà´Ÿàµ à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "2 John", "à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ» à´Žà´´àµà´¤à´¿à´¯ à´°à´£àµà´Ÿà´¾à´‚ à´²àµ‡à´–à´¨à´‚": "2 John", "3 à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "3 John",
    "3à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "3 John", "à´®àµ‚à´¨àµà´¨àµ à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ»": "3 John", "à´¯àµ‹à´¹à´¨àµà´¨à´¾àµ» à´Žà´´àµà´¤à´¿à´¯ à´®àµ‚à´¨àµà´¨à´¾à´‚ à´²àµ‡à´–à´¨à´‚": "3 John",
    "à´¯àµ‚à´¦à´¾à´¸àµ": "Jude", "à´¯àµ‚à´¦à´¾": "Jude", "à´¯àµ‚à´¦à´¾à´¯àµà´Ÿàµ† à´²àµ‡à´–à´¨à´‚": "Jude", "à´µàµ†à´³à´¿à´ªà´¾à´Ÿàµ": "Revelation", "à´µàµ†à´³à´¿à´ªàµà´ªà´¾à´Ÿàµ": "Revelation",
    "à´µàµ†à´³à´¿à´ªà´¾à´Ÿàµà´ªàµà´¸àµà´¤à´•à´‚": "Revelation", "à´µàµ†à´³à´¿à´ªà´¾à´Ÿàµ à´ªàµà´¸àµà´¤à´•à´‚": "Revelation", "à´µàµ†à´³à´¿à´ªà´¾à´Ÿàµ": "Revelation",
}

# ------------------- Malayalam digit map -------------------
ML_DIGITS = str.maketrans({
    "àµ¦": "0", "àµ§": "1", "àµ¨": "2", "àµ©": "3", "àµª": "4",
    "àµ«": "5", "àµ¬": "6", "àµ­": "7", "àµ®": "8", "àµ¯": "9"
})

# ------------------- Ordinals + number words -------------------
ORDINAL_MAP = {
    "à´’à´¨àµà´¨à´¾à´‚": "1", "à´’à´¨àµà´¨à´¾à´®à´¤àµà´¤àµ†": "1", "à´°à´£àµà´Ÿà´¾à´‚": "2", "à´°à´£àµà´Ÿà´¾à´®à´¤àµà´¤àµ†": "2",
    "à´®àµ‚à´¨àµà´¨à´¾à´‚": "3", "à´®àµ‚à´¨àµà´¨à´¾à´®à´¤àµà´¤àµ†": "3", "à´¨à´¾à´²à´¾à´‚": "4", "à´¨à´¾à´²à´¾à´®à´¤àµà´¤àµ†": "4",
    "à´…à´žàµà´šà´¾à´‚": "5", "à´…à´žàµà´šà´¾à´®à´¤àµà´¤àµ†": "5", "à´†à´±à´¾à´‚": "6", "à´†à´±à´¾à´®à´¤àµà´¤àµ†": "6",
    "à´à´´à´¾à´‚": "7", "à´à´´à´¾à´®à´¤àµà´¤àµ†": "7", "à´Žà´Ÿàµà´Ÿà´¾à´‚": "8", "à´Žà´Ÿàµà´Ÿà´¾à´®à´¤àµà´¤àµ†": "8",
    "à´’àµ»à´ªà´¤à´¾à´‚": "9", "à´’àµ»à´ªà´¤à´¾à´®à´¤àµà´¤àµ†": "9", "à´ªà´¤àµà´¤à´¾à´‚": "10", "à´ªà´¤àµà´¤à´¾à´®à´¤àµà´¤àµ†": "10",
    "à´ªà´¤à´¿à´¨àµŠà´¨àµà´¨à´¾à´‚": "11", "à´ªà´¤à´¿à´¨àµŠà´¨àµà´¨à´¾à´®à´¤àµà´¤àµ†": "11", "à´ªà´¨àµà´¤àµà´°à´£àµà´Ÿà´¾à´‚": "12", "à´ªà´¨àµà´¤àµà´°à´£àµà´Ÿà´¾à´®à´¤àµà´¤àµ†": "12",
    "à´ªà´¤à´¿à´®àµ‚à´¨àµà´¨à´¾à´‚": "13", "à´ªà´¤à´¿à´®àµ‚à´¨àµà´¨à´¾à´®à´¤àµà´¤àµ†": "13", "à´ªà´¤à´¿à´¨à´¾à´²à´¾à´‚": "14", "à´ªà´¤à´¿à´¨à´¾à´²à´¾à´®à´¤àµà´¤àµ†": "14",
    "à´ªà´¤à´¿à´¨à´žàµà´šà´¾à´‚": "15", "à´ªà´¤à´¿à´¨à´žàµà´šà´¾à´®à´¤àµà´¤àµ†": "15", "à´ªà´¤à´¿à´¨à´¾à´±à´¾à´‚": "16", "à´ªà´¤à´¿à´¨à´¾à´±à´¾à´®à´¤àµà´¤àµ†": "16",
    "à´ªà´¤à´¿à´¨àµ‡à´´à´¾à´‚": "17", "à´ªà´¤à´¿à´¨àµ‡à´´à´¾à´®à´¤àµà´¤àµ†": "17", "à´ªà´¤à´¿à´¨àµ‡à´°à´¾à´‚": "17", "à´ªà´¤à´¿à´¨àµ†à´Ÿàµà´Ÿà´¾à´‚": "18", "à´ªà´¤à´¿à´¨àµ†à´Ÿàµà´Ÿà´¾à´®à´¤àµà´¤àµ†": "18",
    "à´ªà´¤à´¿à´¨àµŠàµ»à´ªà´¤à´¾à´‚": "19", "à´ªà´¤à´¿à´¨àµŠàµ»à´ªà´¤à´¾à´®à´¤àµà´¤àµ†": "19", "à´‡à´°àµà´ªà´¤à´¾à´‚": "20", "à´‡à´°àµà´ªà´¤à´¾à´®à´¤àµà´¤àµ†": "20",
    
    # ðŸ”§ Added Tens Combiners (Notice the trailing spaces)
    "à´‡à´°àµà´ªà´¤àµà´¤à´¿": "20 ", "à´®àµà´ªàµà´ªà´¤àµà´¤à´¿": "30 ", "à´¨à´¾àµ½à´ªàµà´ªà´¤àµà´¤à´¿": "40 ", "à´…àµ»à´ªà´¤àµà´¤à´¿": "50 ",
    "à´…à´±àµà´ªà´¤àµà´¤à´¿": "60 ", "à´Žà´´àµà´ªà´¤àµà´¤à´¿": "70 ", "à´Žàµºà´ªà´¤àµà´¤à´¿": "80 ", "à´¤àµŠà´£àµà´£àµ‚à´±àµà´±à´¿": "90 ",

    "à´’à´¨àµà´¨àµ": "1", "à´’à´°àµŠà´¨àµà´¨àµ": "1", "à´’à´¨àµà´¨àµ": "1", "à´’à´¨àµà´¨à´¾à´®àµ»": "1",
    "à´°à´£àµà´Ÿàµ": "2", "à´°à´£àµà´Ÿàµ": "2", "à´°à´£àµà´Ÿà´¾à´®àµ»": "2",
    "à´®àµ‚à´¨àµà´¨àµ": "3", "à´®àµ‚à´¨àµà´¨àµ": "3", "à´®àµà´¨àµà´¨àµ": "3", "à´®àµ‚à´¨àµà´¨à´¾à´®àµ»": "3",
    "à´¨à´¾à´²àµ": "4", "à´¨à´¾à´²àµ": "4", "à´¨à´¾à´²à´¾à´®àµ»": "4",
    "à´…à´žàµà´šàµ": "5", "à´…à´žàµà´šàµ": "5", "à´…à´žàµà´šà´¾à´®àµ»": "5",
    "à´†à´±àµ": "6", "à´†à´±àµ": "6", "à´†à´±à´¾à´®àµ»": "6",
    "à´à´´àµ": "7", "à´à´´àµ": "7", "à´à´´à´¾à´®àµ»": "7",
    "à´Žà´Ÿàµà´Ÿàµ": "8", "à´Žà´Ÿàµà´Ÿàµ": "8", "à´Žà´Ÿàµà´Ÿà´¾à´®àµ»": "8",
    "à´’à´®àµà´ªà´¤àµ": "9", "à´’àµ»à´ªà´¤àµ": "9", "à´’à´®àµà´ªà´¤àµ": "9", "à´’à´®àµà´ªà´¤à´¾à´®àµ»": "9",
    "à´ªà´¤àµà´¤àµ": "10", "à´ªà´¤àµà´¤àµ": "10", "à´ªà´¤àµà´¤à´¾à´®àµ»": "10",
    "à´ªà´¤à´¿à´¨àµŠà´¨àµà´¨àµ": "11", "à´ªà´¤à´¿à´¨àµŠà´¨àµà´¨àµ": "11", "à´ªà´¨àµà´¤àµà´°à´£àµà´Ÿàµ": "12", "à´ªà´¨àµà´¤àµà´°à´£àµà´Ÿàµ": "12",
    "à´ªà´¤à´¿à´®àµ‚à´¨àµà´¨àµ": "13", "à´ªà´¤à´¿à´®àµ‚à´¨àµà´¨àµ": "13", "à´ªà´¤à´¿à´¨à´¾à´²àµ": "14", "à´ªà´¤à´¿à´¨à´¾à´²àµ": "14",
    "à´ªà´¤à´¿à´¨à´žàµà´šàµ": "15", "à´ªà´¤à´¿à´¨à´žàµà´šàµ": "15", "à´ªà´¤à´¿à´¨à´¾à´±àµ": "16", "à´ªà´¤à´¿à´¨à´¾à´±àµ": "16",
    "à´ªà´¤à´¿à´¨àµ‡à´´àµ": "17", "à´ªà´¤à´¿à´¨àµ‡à´´àµ": "17", "à´ªà´¤à´¿à´¨àµ‡à´´à´¾à´®àµ»": "17",
    "à´ªà´¤à´¿à´¨àµ†à´Ÿàµà´Ÿàµ": "18", "à´ªà´¤à´¿à´¨àµ†à´Ÿàµà´Ÿàµ": "18", "à´ªà´¤à´¿à´¨àµŠàµ»à´ªà´¤àµ": "19", "à´ªà´¤à´¿à´¨àµŠà´®àµà´ªà´¤àµ": "19",
    "à´‡à´°àµà´ªà´¤àµ": "20", "à´‡à´°àµà´ªà´¤àµ": "20", "à´®àµà´ªàµà´ªà´¤àµ": "30", "à´®àµà´ªàµà´ªà´¤àµ": "30",
    "à´¨à´¾àµ½à´ªàµà´ªà´¤àµ": "40", "à´¨à´¾àµ½à´ªàµà´ªà´¤àµ": "40", "à´…àµ»à´ªà´¤àµ": "50", "à´…àµ»à´ªà´¤àµ": "50",
    "à´…à´±àµà´ªà´¤àµ": "60", "à´…à´±àµà´ªà´¤àµ": "60", "à´Žà´´àµà´ªà´¤àµ": "70", "à´Žà´´àµà´ªà´¤àµ": "70",
    "à´Žàµºà´ªà´¤àµ": "80", "à´Žàµºà´ªà´¤àµ": "80", "à´¤àµŠà´£àµà´£àµ‚à´±àµ": "90", "à´¤àµŠà´£àµà´£àµ‚à´±àµ": "90",
    "à´¨àµ‚à´±àµ": "100", "à´¨àµ‚à´±àµ": "100",
}

NOISE_ML = [
    "à´…à´§àµà´¯à´¾à´¯à´‚", "à´…à´§àµà´¯à´¾.", "à´µà´¾à´•àµà´¯à´‚", "à´µà´¾à´•àµà´¯à´™àµà´™àµ¾", "à´µà´¾.", "à´ªàµà´¸àµà´¤à´•à´‚", 
    "à´²àµ‡à´–à´¨à´‚", "à´Žà´´àµà´¤à´¿à´¯", "à´ªàµà´°à´•à´¾à´°à´‚", "à´¤àµà´±à´•àµà´•àµ‚", "à´µà´¾à´¯à´¿à´•àµà´•àµ‚", "à´¨àµ‹à´•àµà´•àµ‚", 
    "à´•à´¾à´£àµà´•", "à´‰à´³àµà´³", "à´¯àµà´Ÿàµ†"
]

# ------------------- Unicode / Chillu helpers -------------------
CHILLU_MAP = {"àµ»": "à´¨àµ", "àµ¼": "à´°àµ", "àµ¾": "à´³àµ", "àµ½": "à´²àµ", "àµº": "à´£àµ", "à´‚": "à´®àµ"}

def normalize_chillu(s: str) -> str:
    for ch, rep in CHILLU_MAP.items():
        s = s.replace(ch, rep)
    return s

def strip_marks(s: str) -> str:
    return "".join(ch for ch in unicodedata.normalize("NFD", s) if not unicodedata.combining(ch))

def norm_for_match(s: str) -> str:
    s = " ".join(s.split())
    s = normalize_chillu(s)
    return strip_marks(s)

# ------------------- Core conversion -------------------

def normalize_digits(s: str) -> str:
    return s.translate(ML_DIGITS)

def convert_number_words(s: str) -> str:
    for k in sorted(ORDINAL_MAP.keys(), key=len, reverse=True):
        s = s.replace(k, ORDINAL_MAP[k])
        
    # ðŸ”§ FIX: Combine split Malayalam compound numbers (e.g., "40 4" -> "44")
    s = re.sub(
        r'\b(20|30|40|50|60|70|80|90)\s+([1-9])\b', 
        lambda m: str(int(m.group(1)) + int(m.group(2))), 
        s
    )
    return s

# ------------------- Normalize functions -------------------

def normalize_text(s: str) -> str:
    s = normalize_digits(s)
    s = re.sub(r"[à¥¤\.,!?;:\-â€“]", " ", s)
    s = convert_number_words(s)
    for filler in NOISE_ML:
        s = s.replace(filler, " ")
    return " ".join(s.split())

def normalize_numbers_only(s: str) -> str:
    s = normalize_digits(s)
    s = re.sub(r"[à¥¤\.,!?;:\-â€“]", " ", s)
    s = convert_number_words(s)
    return " ".join(s.split())

# ------------------- Book name resolver -------------------

def resolve_book(book_raw: str) -> str | None:
    s = normalize_digits(" ".join(book_raw.split()))
    if s in BOOKS:
        return BOOKS[s]

    parts = s.split()
    if parts and parts[-1].isdigit():
        s = " ".join(parts[:-1])

    prefix_num = None
    parts = s.split()
    if parts and parts[0] in {"1", "2", "3"}:
        prefix_num = parts[0]
        s_wo_num = " ".join(parts[1:])
    else:
        s_wo_num = s

    CASE_SUFFIXES = ("à´¨àµ", "à´¿àµ½", "àµ½", "à´²àµ†", "à´¨àµà´±àµ†", "à´¯àµà´Ÿàµ†", "à´¤àµà´¤à´¿àµ½", "à´•àµà´•àµ", "à´•àµà´•àµ")
    tokens = s_wo_num.split()
    if tokens:
        base_last = tokens[-1]
        for suf in CASE_SUFFIXES:
            if base_last.endswith(suf) and len(base_last) > len(suf) + 1:
                tokens[-1] = base_last[:-len(suf)]
                break
    s_wo_num_trim = " ".join(tokens)

    hay_variants = {norm_for_match(s_wo_num), norm_for_match(s_wo_num_trim)}
    best_key, best_len = None, -1

    for k in BOOKS.keys():
        k_norm = norm_for_match(normalize_digits(k))
        for hay in hay_variants:
            if k_norm and k_norm in normalize_digits(hay):
                if len(k_norm) > best_len:
                    best_key = k
                    best_len = len(k_norm)

    if not best_key:
        if prefix_num and s_wo_num in BOOKS:
            eng = BOOKS[s_wo_num]
            if not eng.startswith((prefix_num + " ")):
                eng = f"{prefix_num} {eng}"
            return eng
        return None

    eng = BOOKS[best_key]
    if prefix_num:
        if eng.startswith(("1 ", "2 ", "3 ")):
            return eng
        return f"{prefix_num} {eng}"
    return eng

# ------------------- Regex pattern & Main Parser -------------------

REF_RE = re.compile(
    r"(?P<book>(?:[1-3]\s*)?[^\d:]+?)\s+(?P<chap>\d{1,3})\s*[: ]\s*(?P<verses>\d{1,3}(?:\s*[-â€“]\s*\d{1,3})?)"
)

def parse_references(text: str):
    if not text:
        return []

    results = []
    t = normalize_text(text)

    for m in REF_RE.finditer(t):
        book_raw = m.group("book").strip()
        chap = m.group("chap")
        verses = m.group("verses").replace("â€“", "-")
        eng = resolve_book(book_raw)
        if eng:
            results.append(f"{eng} {chap}:{verses}")

    if results:
        return results

    for ml_book in sorted(BOOKS.keys(), key=len, reverse=True):
        if ml_book not in text:
            continue

        eng_book = BOOKS[ml_book]
        idx = text.index(ml_book)
        after = text[idx + len(ml_book):]
        after = normalize_text(after)

        m = re.search(r'(\d{1,3})\s*[:\-à¥¤]\s*(\d{1,3})', after)
        if m:
            results.append(f"{eng_book} {m.group(1)}:{m.group(2)}")
            continue

        m2 = re.search(r'(\d{1,3})\D+(\d{1,3})', after)
        if m2:
            results.append(f"{eng_book} {m2.group(1)}:{m2.group(2)}")
            continue

        m3 = re.search(r'(\d{1,3})', after)
        if m3:
            results.append(f"{eng_book} {m3.group(1)}")

    return results

def parse_reference(text: str) -> str | None:
    refs = parse_references(text)
    return refs[0] if refs else None