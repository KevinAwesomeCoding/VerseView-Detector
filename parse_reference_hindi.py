# -*- coding: utf-8 -*-

import re

# ------------------- Hindi â†’ English book mapping -------------------

BOOKS = {
    # OT
    "à¤‰à¤¤à¥à¤ªà¤¤à¥à¤¤à¤¿": "Genesis", "à¤¨à¤¿à¤°à¥à¤—à¤®à¤¨": "Exodus", "à¤²à¥ˆà¤µà¥à¤¯à¤µà¥à¤¯à¤µà¤¸à¥à¤¥à¤¾": "Leviticus", "à¤²à¥ˆà¤µà¥à¤¯": "Leviticus",
    "à¤—à¤¿à¤¨à¤¤à¥€": "Numbers", "à¤µà¥à¤¯à¤µà¤¸à¥à¤¥à¤¾à¤µà¤¿à¤µà¤°à¤£": "Deuteronomy", "à¤µà¥à¤¯à¤µà¤¸à¥à¤¥à¤¾": "Deuteronomy",
    "à¤¯à¤¹à¥‹à¤¶à¥‚": "Joshua", "à¤¨à¥à¤¯à¤¾à¤¯à¤¿à¤¯à¥‹à¤‚": "Judges", "à¤¨à¥à¤¯à¤¾à¤¯à¤¾à¤§à¥€à¤¶": "Judges", "à¤°à¥‚à¤¤": "Ruth",

    # Numbered OT
    "1 à¤¶à¤®à¥‚à¤à¤²": "1 Samuel", "1à¤¶à¤®à¥‚à¤à¤²": "1 Samuel", "à¤à¤• à¤¶à¤®à¥‚à¤à¤²": "1 Samuel",
    "2 à¤¶à¤®à¥‚à¤à¤²": "2 Samuel", "2à¤¶à¤®à¥‚à¤à¤²": "2 Samuel", "à¤¦à¥‹ à¤¶à¤®à¥‚à¤à¤²": "2 Samuel",
    "1 à¤°à¤¾à¤œà¤¾à¤“à¤‚": "1 Kings", "1à¤°à¤¾à¤œà¤¾à¤“à¤‚": "1 Kings", "à¤à¤• à¤°à¤¾à¤œà¤¾à¤“à¤‚": "1 Kings",
    "2 à¤°à¤¾à¤œà¤¾à¤“à¤‚": "2 Kings", "2à¤°à¤¾à¤œà¤¾à¤“à¤‚": "2 Kings", "à¤¦à¥‹ à¤°à¤¾à¤œà¤¾à¤“à¤‚": "2 Kings",
    "1 à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸": "1 Chronicles", "1à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸": "1 Chronicles", "à¤à¤• à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸": "1 Chronicles",
    "2 à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸": "2 Chronicles", "2à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸": "2 Chronicles", "à¤¦à¥‹ à¤‡à¤¤à¤¿à¤¹à¤¾à¤¸": "2 Chronicles",

    # More OT
    "à¤à¤œà¥à¤°à¤¾": "Ezra", "à¤¨à¤¹à¥‡à¤®à¥à¤¯à¤¾à¤¹": "Nehemiah", "à¤à¤¸à¥à¤¤à¥‡à¤°": "Esther", "à¤…à¤¯à¥à¤¯à¥‚à¤¬": "Job",
    "à¤­à¤œà¤¨ à¤¸à¤‚à¤¹à¤¿à¤¤à¤¾": "Psalms", "à¤­à¤œà¤¨": "Psalms", "à¤¨à¥€à¤¤à¤¿à¤µà¤šà¤¨": "Proverbs", "à¤¸à¤­à¥‹à¤ªà¤¦à¥‡à¤¶à¤•": "Ecclesiastes",
    "à¤¶à¥à¤°à¥‡à¤·à¥à¤ à¤—à¥€à¤¤": "Song of Solomon", "à¤¯à¤¶à¤¾à¤¯à¤¾à¤¹": "Isaiah", "à¤¯à¤¶à¤¾à¤¯à¤¾": "Isaiah", "à¤¯à¤¿à¤°à¥à¤®à¤¯à¤¾à¤¹": "Jeremiah",
    "à¤¯à¤¿à¤°à¥à¤®à¤¯à¤¾": "Jeremiah", "à¤µà¤¿à¤²à¤¾à¤ªà¤—à¥€à¤¤": "Lamentations", "à¤¯à¤¹à¥‡à¤œà¤•à¥‡à¤²": "Ezekiel", "à¤¦à¤¾à¤¨à¤¿à¤¯à¥à¤¯à¥‡à¤²": "Daniel",
    "à¤¦à¤¾à¤¨à¤¿à¤à¤²": "Daniel", "à¤¹à¥‹à¤¶à¥‡": "Hosea", "à¤¯à¥‹à¤à¤²": "Joel", "à¤†à¤®à¥‹à¤¸": "Amos", "à¤“à¤¬à¤¦à¥à¤¯à¤¾à¤¹": "Obadiah",
    "à¤¯à¥‹à¤¨à¤¾": "Jonah", "à¤®à¥€à¤•à¤¾": "Micah", "à¤¨à¤¹à¥‚à¤®": "Nahum", "à¤¹à¤¬à¤•à¥à¤•à¥‚à¤•": "Habakkuk", "à¤¸à¤ªà¤¨à¥à¤¯à¤¾à¤¹": "Zephaniah",
    "à¤¹à¤¾à¤—à¥à¤—à¥ˆ": "Haggai", "à¤œà¤•à¤°à¥à¤¯à¤¾à¤¹": "Zechariah", "à¤®à¤²à¤¾à¤•à¥€": "Malachi",

    # NT
    "à¤®à¤¤à¥à¤¤à¥€": "Matthew", "à¤®à¤°à¤•à¥à¤¸": "Mark", "à¤²à¥‚à¤•à¤¾": "Luke", "à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "John",
    "à¤ªà¥à¤°à¥‡à¤°à¤¿à¤¤à¥‹à¤‚ à¤•à¥‡ à¤•à¤¾à¤®": "Acts", "à¤ªà¥à¤°à¥‡à¤°à¤¿à¤¤à¥‹à¤‚": "Acts", "à¤°à¥‹à¤®à¤¿à¤¯à¥‹à¤‚": "Romans",
    "1 à¤•à¥à¤°à¤¿à¤¨à¥à¤¥à¤¿à¤¯à¥‹à¤‚": "1 Corinthians", "1à¤•à¥à¤°à¤¿à¤¨à¥à¤¥à¤¿à¤¯à¥‹à¤‚": "1 Corinthians", "à¤à¤• à¤•à¥à¤°à¤¿à¤¨à¥à¤¥à¤¿à¤¯à¥‹à¤‚": "1 Corinthians",
    "2 à¤•à¥à¤°à¤¿à¤¨à¥à¤¥à¤¿à¤¯à¥‹à¤‚": "2 Corinthians", "2à¤•à¥à¤°à¤¿à¤¨à¥à¤¥à¤¿à¤¯à¥‹à¤‚": "2 Corinthians", "à¤¦à¥‹ à¤•à¥à¤°à¤¿à¤¨à¥à¤¥à¤¿à¤¯à¥‹à¤‚": "2 Corinthians",
    "à¤—à¤²à¤¾à¤¤à¤¿à¤¯à¥‹à¤‚": "Galatians", "à¤‡à¤«à¤¿à¤¸à¤¿à¤¯à¥‹à¤‚": "Ephesians", "à¤«à¤¿à¤²à¤¿à¤ªà¥à¤ªà¤¿à¤¯à¥‹à¤‚": "Philippians", "à¤•à¥à¤²à¥à¤¸à¥à¤¸à¤¿à¤¯à¥‹à¤‚": "Colossians",
    "1 à¤¥à¤¿à¤¸à¥à¤¸à¤²à¥à¤¨à¥€à¤•à¤¿à¤¯à¥‹à¤‚": "1 Thessalonians", "1à¤¥à¤¿à¤¸à¥à¤¸à¤²à¥à¤¨à¥€à¤•à¤¿à¤¯à¥‹à¤‚": "1 Thessalonians", "à¤à¤• à¤¥à¤¿à¤¸à¥à¤¸à¤²à¥à¤¨à¥€à¤•à¤¿à¤¯à¥‹à¤‚": "1 Thessalonians",
    "2 à¤¥à¤¿à¤¸à¥à¤¸à¤²à¥à¤¨à¥€à¤•à¤¿à¤¯à¥‹à¤‚": "2 Thessalonians", "2à¤¥à¤¿à¤¸à¥à¤¸à¤²à¥à¤¨à¥€à¤•à¤¿à¤¯à¥‹à¤‚": "2 Thessalonians", "à¤¦à¥‹ à¤¥à¤¿à¤¸à¥à¤¸à¤²à¥à¤¨à¥€à¤•à¤¿à¤¯à¥‹à¤‚": "2 Thessalonians",
    "1 à¤¤à¥€à¤®à¥à¤¥à¤¿à¤¯à¥à¤¸": "1 Timothy", "1à¤¤à¥€à¤®à¥à¤¥à¤¿à¤¯à¥à¤¸": "1 Timothy", "à¤à¤• à¤¤à¥€à¤®à¥à¤¥à¤¿à¤¯à¥à¤¸": "1 Timothy",
    "2 à¤¤à¥€à¤®à¥à¤¥à¤¿à¤¯à¥à¤¸": "2 Timothy", "2à¤¤à¥€à¤®à¥à¤¥à¤¿à¤¯à¥à¤¸": "2 Timothy", "à¤¦à¥‹ à¤¤à¥€à¤®à¥à¤¥à¤¿à¤¯à¥à¤¸": "2 Timothy",
    "à¤¤à¥€à¤¤à¥à¤¸": "Titus", "à¤«à¤¿à¤²à¥‡à¤®à¥‹à¤¨": "Philemon", "à¤‡à¤¬à¥à¤°à¤¾à¤¨à¤¿à¤¯à¥‹à¤‚": "Hebrews", "à¤¯à¤¾à¤•à¥‚à¤¬": "James",
    "1 à¤ªà¤¤à¤°à¤¸": "1 Peter", "1à¤ªà¤¤à¤°à¤¸": "1 Peter", "à¤à¤• à¤ªà¤¤à¤°à¤¸": "1 Peter",
    "2 à¤ªà¤¤à¤°à¤¸": "2 Peter", "2à¤ªà¤¤à¤°à¤¸": "2 Peter", "à¤¦à¥‹ à¤ªà¤¤à¤°à¤¸": "2 Peter",
    "1 à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "1 John", "1à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "1 John", "à¤à¤• à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "1 John",
    "2 à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "2 John", "2à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "2 John", "à¤¦à¥‹ à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "2 John",
    "3 à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "3 John", "3à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "3 John", "à¤¤à¥€à¤¨ à¤¯à¥‚à¤¹à¤¨à¥à¤¨à¤¾": "3 John",
    "à¤¯à¤¹à¥‚à¤¦à¤¾": "Jude", "à¤ªà¥à¤°à¤•à¤¾à¤¶à¤¿à¤¤à¤µà¤¾à¤•à¥à¤¯": "Revelation", "à¤ªà¥à¤°à¤•à¤¾à¤¶à¤¨": "Revelation",
}

# ------------------- Hindi digit map -------------------
HI_DIGITS = str.maketrans({
    "à¥¦": "0", "à¥§": "1", "à¥¨": "2", "à¥©": "3", "à¥ª": "4",
    "à¥«": "5", "à¥¬": "6", "à¥­": "7", "à¥®": "8", "à¥¯": "9"
})

# ------------------- Hindi number words -------------------
NUMBER_MAP = {
    "à¤à¤•": "1", "à¤¦à¥‹": "2", "à¤¤à¥€à¤¨": "3", "à¤šà¤¾à¤°": "4", "à¤ªà¤¾à¤à¤š": "5", "à¤ªà¤¾à¤‚à¤š": "5",
    "à¤›à¤ƒ": "6", "à¤›à¤¹": "6", "à¤¸à¤¾à¤¤": "7", "à¤†à¤ ": "8", "à¤¨à¥Œ": "9", "à¤¦à¤¸": "10",
    "à¤—à¥à¤¯à¤¾à¤°à¤¹": "11", "à¤¬à¤¾à¤°à¤¹": "12", "à¤¤à¥‡à¤°à¤¹": "13", "à¤šà¥Œà¤¦à¤¹": "14", "à¤ªà¤¨à¥à¤¦à¥à¤°à¤¹": "15",
    "à¤¸à¥‹à¤²à¤¹": "16", "à¤¸à¤¤à¥à¤°à¤¹": "17", "à¤…à¤ à¤¾à¤°à¤¹": "18", "à¤‰à¤¨à¥à¤¨à¥€à¤¸": "19", "à¤¬à¥€à¤¸": "20",
    "à¤‡à¤•à¥à¤•à¥€à¤¸": "21", "à¤¬à¤¾à¤ˆà¤¸": "22", "à¤¤à¥‡à¤ˆà¤¸": "23", "à¤šà¥Œà¤¬à¥€à¤¸": "24", "à¤ªà¤šà¥à¤šà¥€à¤¸": "25",
    "à¤›à¤¬à¥à¤¬à¥€à¤¸": "26", "à¤¸à¤¤à¥à¤¤à¤¾à¤ˆà¤¸": "27", "à¤…à¤Ÿà¥à¤ à¤¾à¤ˆà¤¸": "28", "à¤‰à¤¨à¤¤à¥€à¤¸": "29", "à¤¤à¥€à¤¸": "30",
    # Added Tens up to 100 for proper compound math
    "à¤šà¤¾à¤²à¥€à¤¸": "40", "à¤ªà¤šà¤¾à¤¸": "50", "à¤¸à¤¾à¤ ": "60", "à¤¸à¤¤à¥à¤¤à¤°": "70", "à¤…à¤¸à¥à¤¸à¥€": "80", "à¤¨à¤¬à¥à¤¬à¥‡": "90", "à¤¸à¥Œ": "100"
}

BOOK_FILLERS = ["à¤…à¤§à¥à¤¯à¤¾à¤¯", "à¤µà¤šà¤¨", "à¤ªà¤¦"]

# ------------------- Normalizers -------------------

def normalize_digits(s: str) -> str:
    return s.translate(HI_DIGITS)

def normalize_number_words(s: str) -> str:
    for k in sorted(NUMBER_MAP.keys(), key=len, reverse=True):
        s = s.replace(k, NUMBER_MAP[k])
    
    # ðŸ”§ FIX: Combine split tens and units dynamically (e.g., "40 4" -> "44")
    s = re.sub(
        r'\b(20|30|40|50|60|70|80|90)\s+([1-9])\b', 
        lambda m: str(int(m.group(1)) + int(m.group(2))), 
        s
    )
    return s

def clean_book_name(book: str) -> str:
    for junk in BOOK_FILLERS:
        book = book.replace(junk, "").strip()
    return " ".join(book.split())

def normalize_numbers_only(s: str) -> str:
    """
    âœ… Converts Hindi digits and words, strictly retaining numbers for Layer 2 & ranges.
    """
    s = normalize_digits(s)
    s = re.sub(r"[à¥¤\.,!?;:\-â€“]", " ", s) # Strip punctuation safely
    s = normalize_number_words(s)
    return " ".join(s.split())

# ------------------- Main parser -------------------

def parse_references(text: str):
    if not text:
        return []

    results = []
    text = normalize_digits(text)
    text = normalize_number_words(text)

    for hi_book in sorted(BOOKS.keys(), key=len, reverse=True):
        if hi_book in text:
            eng_book = BOOKS[hi_book]
            idx = text.index(hi_book)
            after = text[idx + len(hi_book):].strip()

            for filler in BOOK_FILLERS:
                after = after.replace(filler, "").strip()

            m = re.search(r'(\d{1,3})\s*[:\-à¥¤]\s*(\d{1,3})', after)
            if m:
                results.append(f"{eng_book} {m.group(1)}:{m.group(2)}")
                continue

            m2 = re.search(r'(\d{1,3})\D+(\d{1,3})', after)
            if m2:
                results.append(f"{eng_book} {m2.group(1)}:{m2.group(2)}")

    return results